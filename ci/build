#!/bin/sh
set -e
set -u

. ci/functions.sh
verbosity=1

cat > ci/vars <<EOF
  VERSION=1.4.0
  BUILD_DATE=$(date +%Y%m%dT%H%M)
  VCS_REF=$(git describe --abbrev=7 --tags --always)
  TAG=\${VERSION}-\${BUILD_DATE}-git-\${VCS_REF}

  export VERSION
  export BUILD_DATE
  export VCS_REF
  export TAG
EOF

. ci/vars

ci/clean

echo
echo Build the builder.
docker-compose build builder

echo
echo Copy binary into local directory.
docker create --name scanbuild builder true
docker cp scanbuild:/tmp/ssllabs-scan-${VERSION}/ssllabs-scan .

echo
echo Copy certs into local directory.
docker cp scanbuild:/etc/ssl/certs/ca-certificates.crt .

echo
echo Build the runtime image.
docker-compose build scanner

echo
echo Build an image we use in the test harness.
docker-compose build sleeper

echo
echo Show image sizes.
docker images | grep ssllabs-scan
