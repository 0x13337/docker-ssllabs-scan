#!/bin/sh
set -e

cat > ci/vars <<EOF
  VERSION=1.4.0
  BUILD_DATE=$(date +%Y%m%dT%H%M)
  VCS_REF=${CIRCLE_SHA1:0:7}
  TAG=\${VERSION}-\${BUILD_DATE}-git-\${VCS_REF}

  export VERSION
  export BUILD_DATE
  export VCS_REF
  export TAG
EOF

. ci/vars

ci/clean

# Build the builder.
docker build \
  --build-arg VERSION=${VERSION} \
  -t scanbuild -f Dockerfile.build .

# Copy binary into local directory.
docker create --name scanbuild scanbuild true
docker cp scanbuild:/tmp/ssllabs-scan-${VERSION}/ssllabs-scan .

# Copy certs into local directory.
docker cp scanbuild:/etc/ssl/certs/ca-certificates.crt .

# Build the runtime image.
docker build \
  --build-arg CI_BUILD_URL=${CIRCLE_BUILD_URL} \
  --build-arg BUILD_DATE=${BUILD_DATE} \
  --build-arg VCS_REF=${VCS_REF} \
  --build-arg VERSION=${VERSION} \
  -t jumanjiman/ssllabs-scan -f Dockerfile.runtime .

# Show image sizes.
docker images | grep ssllabs-scan
